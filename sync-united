#!/bin/bash
#
# +-----------------------------------------------------------------------------------+
# | Copyright (C) 2017 David Vasquez    					      |
# | MIT license                                                                       |                                              
# | Permission is hereby granted, free of charge, to any person obtaining a copy of   |	
# | this software and associated documentation files (the "Software"), to deal in the | 
# | Software without restriction, including without limitation the rights to use,     |
# | copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the   | 
# | Software, and to permit persons to whom the Software is furnished to do so,       |
# | subject to the following conditions:                                              |
#
# | The above copyright notice and this permission notice shall be included in all    | 
# | copies or substantial portions of the Software.                                   |
#                                                       
# | THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR        |
# | IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS  |
# | FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR    |
# | COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN |
# | AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION   |
# | WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.                   |                                                 
# +-----------------------------------------------------------------------------------+
# | This code is designed, written and maintained by David Vasquez    		      |
# | Any questions, comments or advice on this code                                    |
# | should be addressed to:                                                           |
# | davidva@tutanota.com                                                              |
# +-----------------------------------------------------------------------------------+
# The script is a shit because it doesn't has 60 lines ;)

usage() {
  echo ""
  echo -e '\e[33m  -s sync\e[0m'
  echo "    synchronizes the cloud"
  echo "Usage: $0 -s 25"
  echo ""
  exit 1
}

readargs() {
  while [ "$#" -gt 0 ] ; do
    case "$1" in
       -s)
        if [ "$2" ] ; then
          task="$2"
          shift ; shift
        else
          echo "Missing a value for $1."
          echo
          shift
          usage
        fi
      ;;
      *)
        echo "Unknown option or argument $1."
        echo
        shift
        usage
      exit
      ;;
    esac
  done
}


sf_back() {
sshpass -f $HOME/.chirubito rsync -avP --backup "${user}@frs.sourceforge.net:/home/frs/project/unitedrpms/${task}/" ${motherpath}/
# sshpass -f $HOME/.chirubito rsync -avP --backup "${user}@frs.sourceforge.net:/home/frs/project/muchpack/${task}/" ${motherpath}/
}

clean_old() {
echo -e "\e[31mDelete old versions...\e[0m"
rm -f $(dnf repomanage --keep=1 --old ${motherpath}/x86_64/)
rm -f $(dnf repomanage --keep=1 --old ${motherpath}/x86_64/debug/)
rm -f $(dnf repomanage --keep=1 --old ${motherpath}/srpm/)
}

make_repo() {
rm -rf repodata/
createrepo . 
repoview . 
}

sign_repo() {
echo -e "\e[31mSign repodata...\e[0m"
/usr/bin/gpg2 --local-user 'The UnitedRPMs Project' --yes --detach-sign --armor repodata/repomd.xml
}

sign_rpm() {
rpm --define "_gpg_name The UnitedRPMs Project" --addsign *.rpm
repoview .
}


sfsync() {
echo -e "\e[31mSync with Sf...\e[0m"
pushd ${motherpath}
sshpass -f $HOME/.chirubito rsync -av --delete x86_64/repoview/ ${user}@frs.sourceforge.net:/home/frs/project/unitedrpms/${task}/x86_64/repoview/ 
sshpass -f $HOME/.chirubito rsync -av --delete x86_64/repoview/ ${user}@frs.sourceforge.net:/home/project-web/unitedrpms/htdocs/x86_64/repoview/

sshpass -f $HOME/.chirubito rsync -av --delete x86_64/debug/repoview/ ${user}@frs.sourceforge.net:/home/frs/project/unitedrpms/${task}/x86_64/debug/repoview/
sshpass -f $HOME/.chirubito rsync -av --delete x86_64/debug/repoview/ ${user}@frs.sourceforge.net:/home/project-web/unitedrpms/htdocs/x86_64/debug/repoview/

sshpass -f $HOME/.chirubito rsync -av --delete srpm/repoview/ ${user}@frs.sourceforge.net:/home/frs/project/unitedrpms/${task}/srpm/repoview/ 
sshpass -f $HOME/.chirubito rsync -av --delete srpm/repoview/ ${user}@frs.sourceforge.net:/home/project-web/unitedrpms/htdocs/srpm/repoview/
sshpass -f $HOME/.chirubito rsync -av --delete srpm/repodata/ ${user}@frs.sourceforge.net:/home/project-web/unitedrpms/${task}/srpm/repodata/

sshpass -f $HOME/.chirubito rsync -av --delete x86_64/repodata/ ${user}@frs.sourceforge.net:/home/frs/project/${task}/x86_64/repodata/
sshpass -f $HOME/.chirubito rsync -av --delete x86_64/debug/repodata/ ${user}@frs.sourceforge.net:/home/frs/project/unitedrpms/${task}/x86_64/debug/repodata/

# sshpass -f $HOME/.chirubito rsync -av --ignore-existing x86_64/ ${user}@frs.sourceforge.net:/home/frs/project/unitedrpms/${task}/x86_64/
sshpass -f $HOME/.chirubito rsync -av --delete . ${user}@frs.sourceforge.net:/home/frs/project/unitedrpms/${task}/

popd
}



muchsfsync() {
echo -e "\e[31mSync with Much Sf...\e[0m"
pushd ${motherpath}
sshpass -f $HOME/.chirubito rsync -av --delete x86_64/repoview/ ${user}@frs.sourceforge.net:/home/frs/project/muchpack/${task}/x86_64/repoview/ 
sshpass -f $HOME/.chirubito rsync -av --delete x86_64/repoview/ ${user}@frs.sourceforge.net:/home/project-web/muchpack/htdocs/x86_64/repoview/

sshpass -f $HOME/.chirubito rsync -av --delete x86_64/debug/repoview/ ${user}@frs.sourceforge.net:/home/frs/project/muchpack/${task}/x86_64/debug/repoview/
sshpass -f $HOME/.chirubito rsync -av --delete x86_64/debug/repoview/ ${user}@frs.sourceforge.net:/home/project-web/muchpack/htdocs/x86_64/debug/repoview/

sshpass -f $HOME/.chirubito rsync -av --delete srpm/repoview/ ${user}@frs.sourceforge.net:/home/frs/project/muchpack/${task}/srpm/repoview/ 
sshpass -f $HOME/.chirubito rsync -av --delete srpm/repoview/ ${user}@frs.sourceforge.net:/home/project-web/muchpack/htdocs/srpm/repoview/
sshpass -f $HOME/.chirubito rsync -av --delete srpm/repodata/ ${user}@frs.sourceforge.net:/home/project-web/muchpack/${task}/srpm/repodata/

sshpass -f $HOME/.chirubito rsync -av --delete x86_64/repodata/ ${user}@frs.sourceforge.net:/home/frs/project/${task}/x86_64/repodata/
sshpass -f $HOME/.chirubito rsync -av --delete x86_64/debug/repodata/ ${user}@frs.sourceforge.net:/home/frs/project/muchpack/${task}/x86_64/debug/repodata/

# sshpass -f $HOME/.chirubito rsync -av --ignore-existing x86_64/ ${user}@frs.sourceforge.net:/home/frs/project/unitedrpms/${task}/x86_64/
sshpass -f $HOME/.chirubito rsync -av --delete . ${user}@frs.sourceforge.net:/home/frs/project/muchpack/${task}/

popd
}


mdow() {
echo -e "\e[31mDownloading updates...\e[0m"
megacopy --local "${raiz}" --remote /Root/unitedrpms/updates/${task}/ --download
}

Cardow() {
echo -e "\e[31mDownloading updates of travis-rpm-builder...\e[0m"
curl -s https://api.github.com/repos/UnitedRPMs/travis-rpm-builder/releases | grep browser_download_url | cut -d '"' -f 4 > $HOME/urls_mock_travis
utra=$HOME/urls_mock_travis
while IFS= read -r urlst; do
wget -c -P ${raiz}/ $urlst 
done <"$utra"
}

work_directory() {
mkdir -p ${motherpath}
mkdir -p "${raiz}"
mkdir -p ${motherpath}/srpm/repoview/
mkdir -p ${motherpath}/srpm/repodata/
mkdir -p ${motherpath}/x86_64/debug/
mkdir -p ${motherpath}/x86_64/repodata/
}


m_mv() {
pushd "${raiz}"
fdupes -d $PWD
mv -f *src.rpm ${motherpath}/srpm/
mv -f *debuginfo*.rpm ${motherpath}/x86_64/debug/
mv -f *.rpm ${motherpath}/x86_64/
popd
}

clean_trash() {
find $PWD/ -name "*~" -exec rm -f  {} ${motherpath}/ \;
}

job() {
pushd ${motherpath}/x86_64/
clean_old
sign_rpm
clean_trash
make_repo
sign_repo
popd

pushd ${motherpath}/x86_64/debug/ 
clean_old
sign_rpm
clean_trash
make_repo
sign_repo
popd

pushd ${motherpath}/srpm/
clean_old
sign_rpm 
clean_trash
make_repo
sign_repo
popd
}

mupl() {

# LIST PACKAGES IN LOCAL
pushd ${motherpath}/x86_64/
ls *.rpm | grep -ve repodata -e repoview -e debug | sort -u > $HOME/output-result-rpms.txt
popd

pushd ${motherpath}/x86_64/debug/
ls *.rpm | grep -ve repodata -e repoview | sort -u > $HOME/output-result-debugs.txt
popd

pushd ${motherpath}/srpm/
ls *src.rpm | grep -ve repodata -e repoview | sort -u > $HOME/output-result-srpms.txt
popd

# LIST PACKAGES IN CLOUD
# RPMS
megals --names /Root/unitedrpms/${task}/x86_64/ | grep -ve repodata -e repoview > /tmp/megalist${task}

# DEBUG
megals --names /Root/unitedrpms/${task}/x86_64/debug/ | grep -ve repodata -e repoview > /tmp/megalist${task}_debug

# SRPM
megals --names /Root/unitedrpms/${task}/srpm/ | grep -ve repodata -e repoview > /tmp/megalist${task}_SR
#

echo -e "\e[31mSync with Mega...\e[0m"
if [ -f ${motherpath}/x86_64/repodata/repomd.xml ]; then

# DELETE OLD REPODATA AND REPOVIEW IN MG
megarm /Root/unitedrpms/${task}/x86_64/repodata
megarm /Root/unitedrpms/${task}/x86_64/debug/repodata
megarm /Root/unitedrpms/${task}/srpm/repodata
fi

if [ -f ${motherpath}/x86_64/repoview/index.html ]; then
megarm /Root/unitedrpms/${task}/x86_64/repoview
megarm /Root/unitedrpms/${task}/x86_64/debug/repoview
megarm /Root/unitedrpms/${task}/srpm/repoview
fi

# NOW THE REAL SYNC WITH MG
# RPMS
Ou=$HOME/output-result-rpms.txt
while IFS= read -r result; do
pushd ${motherpath}/x86_64/
if [ $(ls $result | grep -c fc${task}) -gt 0 ] && [ -f /tmp/megalist${task} ] && [ $(cat /tmp/megalist${task} | grep -c $result) -lt 1 ]; then
megaput $result --path /Root/unitedrpms/${task}/x86_64/
fi
done <"$Ou"
popd

# DEBUG
Oa=$HOME/output-result-debugs.txt
pushd ${motherpath}/x86_64/debug/
while IFS= read -r resultb; do
if [ $(ls $resultb | grep -c fc${task}) -gt 0 ] && [ -f /tmp/megalist${task}_debug ] && [ $(cat /tmp/megalist${task}_debug | grep -c $resultb ) -lt 1 ]; then
megaput $resultb --path /Root/unitedrpms/${task}/x86_64/debug/
fi
done <"$Oa"
popd


# SRPM
Oe=$HOME/output-result-srpms.txt
pushd ${motherpath}/srpm/
while IFS= read -r resultc; do
if [ $(ls $resultc | grep -c fc${task}) -gt 0 ] && [ -f /tmp/megalist${task}_SR ] && [ $( cat /tmp/megalist${task}_SR | grep -c $resultc ) -lt 1 ]; then
megaput $resultc --path /Root/unitedrpms/${task}/srpm/
fi
done <"$Oe"
popd

# SYNC REPODATA AND REPOVIEW
megamkdir /Root/unitedrpms/${task}/x86_64/debug/repodata
megamkdir /Root/unitedrpms/${task}/x86_64/debug/repoview
megamkdir /Root/unitedrpms/${task}/x86_64/repodata
megamkdir /Root/unitedrpms/${task}/x86_64/repoview
megamkdir /Root/unitedrpms/${task}/srpm/repodata
megamkdir /Root/unitedrpms/${task}/srpm/repoview

#megacopy --local ${motherpath}/x86_64/debug/repodata --remote /Root/unitedrpms/${task}/x86_64/debug/repodata
#megacopy --local ${motherpath}/x86_64/debug/repoview --remote /Root/unitedrpms/${task}/x86_64/debug/repoview 
#megacopy --local ${motherpath}/x86_64/repodata --remote /Root/unitedrpms/${task}/x86_64/repodata
#megacopy --local ${motherpath}/x86_64/repoview --remote /Root/unitedrpms/${task}/x86_64/repoview
#megacopy --local ${motherpath}/srpm/repodata --remote /Root/unitedrpms/${task}/srpm/repodata
#megacopy --local ${motherpath}/srpm/repoview --remote /Root/unitedrpms/${task}/srpm/repoview
rm -f /tmp/megalist*
echo 'Completed sync with Mega'
}

checkfiles() {
if [ "$(ls -A ${raiz})" ]; then
echo "Great ${raiz} is not Empty"
else
echo "${raiz} is Empty"
exit 0
fi
}

metadata_sync() {
pushd ${motherpath}/x86_64/
rm -rf $PWD/debug/
rm -rf $PWD/repoview/
rm -rf $PWD/repodata/
mkdir -p $PWD/tmp/
mkdir -p $PWD/appstream-data/
appstream-builder --max-threads=6 --log-dir=./logs/ --packages-dir=$PWD --temp-dir=$PWD/tmp/ --output-dir=$PWD/appstream-data/ --basename="unitedrpms" --origin="unitedrpms" --enable-hidpi
popd
}

metadata_tag_git() {
pushd ${motherpath}/x86_64/ 
source ~/.bashrc
date_data=$(date "+%m/%d/%y%n")

github-release delete \
    --user UnitedRPMs \
    --repo unitedrpms-appstream-data \
    --tag ${date_data}

github-release release \
    --user UnitedRPMs \
    --repo unitedrpms-appstream-data \
    --tag ${date_data} \
    --name "unitedrpms-appdata" \
    --description "Not a movie, contrary to popular opinion. The magic is here!" 

ls $PWD/appstream-data/ > /tmp/file_metadata
echo 'files listed...'
cat /tmp/file_metadata


github-release upload \
    --user UnitedRPMs \
    --repo unitedrpms-appstream-data \
    --tag ${date_data} \
    --name "unitedrpms-appdata" \
    --file $PWD/appstream-data/unitedrpms.xml.gz

github-release upload \
    --user UnitedRPMs \
    --repo unitedrpms-appstream-data \
    --tag ${date_data} \
    --name "unitedrpms-appdata" \
    --file $PWD/appstream-data/unitedrpms-icons.tar.gz

github-release upload \
    --user UnitedRPMs \
    --repo unitedrpms-appstream-data \
    --tag ${date_data} \
    --name "unitedrpms-appdata" \
    --file $PWD/appstream-data/unitedrpms-screenshots.tar
popd
}


#-----------------------

#  BEGIN THE PROGRAM
readargs "$@"

user=kuboosoft
raiz=$HOME/f${task}
motherpath=$HOME/${task}

if [ ${task} = 24 ] || [ ${task} = 25 ] || [ ${task} = 26 ] || [ ${task} = 27 ] || [ ${task} = 28 ]; then
echo -e "\e[32msync limited to F24-F28...\e[0m"
echo -e "\e[32mCurrent sync with F${task} ...\e[0m"
else
echo 'ERROR'
echo -e "\e[32mSorry, check if exists the current release...\e[0m"
exit
fi


if [ ! -f /usr/bin/fdupes ] ; then
dnf -y install fdupes
fi
work_directory
sf_back
#Cardow
mdow
checkfiles
m_mv
job
#muchsfsync
sfsync
mupl
metadata_sync
metadata_tag_git

rm -rf "${motherpath}"
rm -rf "${raiz}"
echo 'DONE'

